<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http
://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>

		<title lang="en">Community Moderation</title>

		<description lang="en">This mod adds "upvote" and "downvote" buttons to every post, as well as the posts's score. Each user has one vote they can cast on each post, adjusting the score up or down by one point. If a post reaches the "low" threshold, it is hidden. The hiding is the same style hiding used to hide posts by "foes". A new permission is added to allow users/groups to vote on posts (forum permissions -> Post -> Can vote on posts). Users can set their threshold for hiding posts in the UCP, and this overrides the setting in the ACP. Voting can be completely disabled at anytime thru the ACP -> General -> Board Configuration -> Post Settings -> Postings. By implementing this voting system, forum communities can gain some control over board content without admin or moderator help.</description>

		<author-notes lang="en">Thanks to Mack for the concept and original code. Thanks also to m157y, whose Karma MOD (http://www.phpbb.com/customise/db/mod/karma_mod/) I used as a guide for injecting data into viewtopic.php</author-notes>

		<author-group>
			<author>
				<realname>Jamie Hall</realname>
				<username>Mav</username>
				<homepage>http://www.packetecho.com/phpBB3/</homepage>
				<email><![CDATA[mail@packetecho.com]]></email>
			</author>
			<author>
				<realname>Mack Staples</realname>
				<username>mackstaples</username>
			</author>
		</author-group>

		<mod-version>0.0.3</mod-version>

		<installation>
			<level>intermediate</level>
			<time>1200</time>
			<target-version>3.0.7-pl1</target-version>
		</installation>

		<history>
			<entry>
				<date>2010-06-20</date>
				<rev-version>0.0.1</rev-version>
				<changelog lang="en">
					<change>Initial release</change>
				</changelog>
			</entry>
			<entry>
				<date>2010-06-21</date>
				<rev-version>0.0.2</rev-version>
				<changelog lang="en">
					<change>Minor edit to includes/functions_community_moderation.php</change>
				</changelog>
			</entry>
			<entry>
				<date>2010-06-26</date>
				<rev-version>0.0.3</rev-version>
				<changelog lang="en">
					<change>Moved all LANG entries into their own files. ACP settings moved into a new module. Added support for Ultimate Points System. Renamed $mode variable to $vmode. Added user permissions to set bury threshold, and to select which posts to bury (all, none, not friends)</change>
				</changelog>
			</entry>
		</history>
		<link-group>
			<link type="contrib" href="./contrib/update_001_002.xml" lang="en">Update from 0.0.1 to 0.0.2</link>
			<link type="contrib" href="./contrib/update_002_003.xml" lang="en">Update from 0.0.2 to 0.0.3</link>
		</link-group>
		<meta name="generator" content="MODX file generated by MODX Generator by tumba25" />
	</header>

	<action-group>
		<copy>
			<file from="root/*.*" to="*.*" />
		</copy>
		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[$start		= request_var('start', 0);
$view		= request_var('view', '');]]></find>
				<action type="after-add"><![CDATA[//-- mod : Community Moderation ------------------------------------------------------------
$force		= request_var('force', '');
$vmode		= request_var('vmode', '');

if (!class_exists('community_moderation'))
{
	require($phpbb_root_path . 'includes/functions_community_moderation.' . $phpEx);
}
//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[	'WARN_IMG'			=> $user->img('icon_user_warn', 'WARN_USER'),]]></find>
				<action type="after-add"><![CDATA[	//-- mod : Community Moderation ------------------------------------------------------------
	'UPVOTE_IMG'		=> $user->img('icon_post_upvote', 'UPVOTE'),
	'DOWNVOTE_IMG'		=> $user->img('icon_post_downvote', 'DOWNVOTE'),
	//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[	'WHERE'		=> $db->sql_in_set('p.post_id', $post_list) . '
		AND u.user_id = p.poster_id'
));]]></find>
				<action type="after-add"><![CDATA[
//-- mod : Community Moderation ------------------------------------------------------------
global $community_moderation;
$community_moderation = new community_moderation();

if ($vmode)
{
	// Check the mode...
	if (!in_array($vmode, array('upvote','downvote')))
	{
		trigger_error('NO_MODE');
	}

	$community_moderation->record_vote_info($vmode, $post_id, $auth, $viewtopic_url, $forum_id);
}

$community_moderation->viewtopic_sql($sql);
//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[		'post_edit_locked'	=> $row['post_edit_locked'],]]></find>
				<action type="after-add"><![CDATA[		//-- mod : Community Moderation ------------------------------------------------------------
		'post_upvotes'		=> $row['post_upvotes'],
		'post_downvotes'	=> $row['post_downvotes'],
		'post_score'		=> (isset($row['post_score'])) ? $row['post_score'] : '',
		'is_buried'		=> (isset($row['is_buried'])) ? $row['is_buried'] : '',
		'has_voted'		=> (isset($row['has_voted'])) ? $row['has_voted'] : '',
		//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[	// Define the global bbcode bitfield, will be used to load bbcodes]]></find>
				<action type="before-add"><![CDATA[	//-- mod : Community Moderation ------------------------------------------------------------
	$community_moderation->viewtopic_rowset($rowset[$row['post_id']], $user, $row, $force);
	//-- fin mod : Community Moderation --------------------------------------------------------
	]]></action>
			</edit>
			<edit>
				<find><![CDATA[	// Dump vars into template
	$template->assign_block_vars('postrow', $postrow);]]></find>
				<action type="before-add"><![CDATA[	//-- mod : Community Moderation ------------------------------------------------------------
	$community_moderation->viewtopic_postrow($postrow, $auth, $user_cache[$poster_id], $poster_id, $row, $viewtopic_url, $forum_id);
	//-- fin mod : Community Moderation --------------------------------------------------------
	]]></action>
			</edit>
		</open>
		<open src="adm/style/acp_users_prefs.html">
			<edit>
				<find><![CDATA[		<dd>{S_POST_SORT_DIR}</dd>
	</dl>]]></find>
				<action type="after-add"><![CDATA[	<dl>
		<dt><label for="post_threshold">{L_POSTS_BURY_THRESHOLD}:</label><br /><span>{L_POSTS_BURY_THRESHOLD_EXPLAIN}</span></dt>
		<dd><input type="text" id="post_threshold" name="post_threshold" value="{BURY_THRESHOLD}" maxlength="3" size="5" /></dd>
	</dl>
	<dl>
		<dt><label for="bury_hide">{L_BURY_HIDE}:</label><br /><span>{L_BURY_HIDE_EXPLAIN}</span></dt>
		<dd><label for="bury_hide"><input type="radio" name="bury_hide" value="2"<!-- IF BURY_HIDE == 2 --> id="bury_hide" checked="checked"<!-- ENDIF --> /> {L_BURY_HIDE_NONE}</label>
			<label for="bury_hide"><input type="radio" name="bury_hide" value="1"<!-- IF BURY_HIDE == 1 --> id="bury_hide" checked="checked"<!-- ENDIF --> /> {L_BURY_HIDE_FRIENDS}</label>
			<label for="bury_hide"><input type="radio" name="bury_hide" value="0"<!-- IF BURY_HIDE == 0 --> id="bury_hide" checked="checked"<!-- ENDIF --> /> {L_BURY_HIDE_ALL}</label></dd>
	</dl>]]></action>
			</edit>
		</open>
		<open src="includes/constants.php">
			<edit>
				<find><![CDATA[// Additional tables]]></find>
				<action type="after-add"><![CDATA[define('VOTES_TABLE', $table_prefix . 'posts_votes');]]></action>
			</edit>
		</open>
		<open src="includes/functions_admin.php">
			<edit>
				<find><![CDATA[	$table_ary = array(POSTS_TABLE, REPORTS_TABLE);]]></find>
				<action type="after-add"><![CDATA[	//-- mod : Community Moderation ------------------------------------------------------------
	$table_ary[] = VOTES_TABLE;
	//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
		</open>
		<open src="includes/acp/acp_styles.php">
			<edit>
				<find><![CDATA[, 'icon_post_report']]></find>
				<inline-edit>
					<inline-find><![CDATA[, 'icon_post_report']]></inline-find>
					<inline-action type="after-add"><![CDATA[, 'icon_post_upvote', 'icon_post_downvote']]></inline-action>
				</inline-edit>
			</edit>
		</open>
		<open src="includes/acp/acp_users.php">
			<edit>
				<find><![CDATA[					'post_st'			=> request_var('post_st', ($user_row['user_post_show_days']) ? $user_row['user_post_show_days'] : 0),]]></find>
				<action type="after-add"><![CDATA[					//-- mod : Community Moderation ------------------------------------------------------------
					'post_threshold'	=> request_var('post_threshold', $user_row['user_posts_bury_threshold']),
					'bury_hide'			=> request_var('bury_hide', $user_row['user_posts_bury_hide']),
					//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[						'post_sd'		=> array('string', false, 1, 1),]]></find>
				<action type="after-add"><![CDATA[						//-- mod : Community Moderation ------------------------------------------------------------
						'post_threshold'	=> array('num', false, -99, -1),
						'bury_hide'		=> array('num', false, 0, 2),
						//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[							'user_post_sortby_dir'		=> $data['post_sd'],]]></find>
				<action type="after-add"><![CDATA[							//-- mod : Community Moderation ------------------------------------------------------------
							'user_posts_bury_threshold'		=> $data['post_threshold'],
							'user_posts_bury_hide'			=> $data['bury_hide'],
							//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[					'VIEW_WORDCENSOR'	=> $data['view_wordcensor'],]]></find>
				<action type="after-add"><![CDATA[					//-- mod : Community Moderation ------------------------------------------------------------
					'BURY_THRESHOLD'	=> $data['post_threshold'],
					'BURY_HIDE'			=> $data['bury_hide'],
					//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
		</open>
		<open src="includes/ucp/ucp_prefs.php">
			<edit>
				<find><![CDATA[					'post_st'		=> request_var('post_st', (!empty($user->data['user_post_show_days'])) ? $user->data['user_post_show_days'] : 0),]]></find>
				<action type="after-add"><![CDATA[					//-- mod : Community Moderation ------------------------------------------------------------
					'post_threshold'	=> request_var('post_threshold', (int) $user->data['user_posts_bury_threshold']),
					'bury_hide'		=> request_var('bury_hide', (int) $user->data['user_posts_bury_hide']),
					//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[						'post_sd'	=> array('string', false, 1, 1),]]></find>
				<action type="after-add"><![CDATA[						//-- mod : Community Moderation ------------------------------------------------------------
						'post_threshold'	=> array('num', false, -99, -1),
						'bury_hide'	=> array('num', false, 0, 2),
						//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[							'user_post_show_days'	=> $data['post_st'],]]></find>
				<action type="after-add"><![CDATA[							//-- mod : Community Moderation ------------------------------------------------------------
							'user_posts_bury_threshold'	=> $data['post_threshold'],
							'user_posts_bury_hide'		=> $data['bury_hide'],
							//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[					'S_DISABLE_CENSORS'	=> $data['wordcensor'],]]></find>
				<action type="after-add"><![CDATA[					//-- mod : Community Moderation ------------------------------------------------------------
					'S_BURY_THRESHOLD'	=> $data['post_threshold'],
					'S_BURY_HIDE'		=> $data['bury_hide'],

					'S_CAN_BURY_THRESHOLD'	=> ($auth->acl_get('u_com_threshold')) ? true : false,
					'S_CAN_BURY_HIDE'		=> ($auth->acl_get('u_com_style')) ? true : false,
					//-- fin mod : Community Moderation --------------------------------------------------------]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/imageset/imageset.cfg">
			<edit>
				<find><![CDATA[img_icon_user_warn = icon_user_warn.gif*20*20]]></find>
				<action type="after-add"><![CDATA[img_icon_post_upvote = icon_post_upvote.gif*20*16
img_icon_post_downvote = icon_post_downvote.gif*20*16]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/ucp_prefs_view.html">
			<edit>
				<find><![CDATA[			<dd>{S_POST_SORT_DIR}</dd>
		</dl>]]></find>
				<action type="after-add"><![CDATA[		<hr />
		<!-- IF S_CAN_BURY_THRESHOLD -->
		<dl>
			<dt><label for="post_threshold">{L_POST_THRESHOLD}:</label><br /><span>{L_POST_THRESHOLD_EXPLAIN}</span></dt>
			<dd><input type="text" id="post_threshold" name="post_threshold" value="{S_BURY_THRESHOLD}" maxlength="3" size="5" /></dd>
		</dl>
		<!-- ENDIF -->
		<!-- IF S_CAN_BURY_HIDE -->
		<dl>
			<dt><label for="bury_hide2">{L_BURY_HIDE}:</label><br /><span>{L_BURY_HIDE_EXPLAIN}</span></dt>
			<dd>
				<label for="bury_hide2"><input type="radio" name="bury_hide" id="bury_hide2" value="2"<!-- IF S_BURY_HIDE == 2 --> checked="checked"<!-- ENDIF --> /> {L_BURY_HIDE_NONE}</label>
				<label for="bury_hide1"><input type="radio" name="bury_hide" id="bury_hide1" value="1"<!-- IF S_BURY_HIDE == 1 --> checked="checked"<!-- ENDIF --> /> {L_BURY_HIDE_FRIENDS}</label>
				<label for="bury_hide0"><input type="radio" name="bury_hide" id="bury_hide0" value="0"<!-- IF S_BURY_HIDE == 0 --> checked="checked"<!-- ENDIF --> /> {L_BURY_HIDE_ALL}</label>
			</dd>
		</dl>
		<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/viewtopic_body.html">
			<edit>
				<find><![CDATA[				<div class="ignore">{postrow.L_IGNORE_POST}</div>]]></find>
				<action type="after-add"><![CDATA[        	<!-- ELSEIF postrow.S_BURIED_POST -->
				<div class="ignore">{postrow.L_BURIED_POST}</div>]]></action>
			</edit>
			<edit>
				<find><![CDATA[					<!-- IF postrow.U_QUOTE --><li class="quote-icon"><a href="{postrow.U_QUOTE}" title="{L_REPLY_WITH_QUOTE}"><span>{L_REPLY_WITH_QUOTE}</span></a></li><!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[					<!-- IF postrow.S_COMMUNITY_MOD_ENABLED -->
					  <!-- IF postrow.S_CAN_COMMUNITY_MOD and not postrow.S_HAS_VOTED -->
               	      			  <li class="upvote-icon"><a href="{postrow.U_UPVOTE}" title="{L_UPVOTE}"><span>{L_UPVOTE}</span></a></li>
					  <li class="downvote-icon"><a href="{postrow.U_DOWNVOTE}" title="{L_DOWNVOTE}"><span>{L_DOWNVOTE}</span></a></li>
					  <!-- ENDIF -->
					<li class="score" title="+{postrow.POST_UPVOTES} -{postrow.POST_DOWNVOTES}">{postrow.POST_SCORE}<span>{L_POST_SCORE}</span></li>
					<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/theme/buttons.css">
			<edit>
				<find><![CDATA[/* Set profile icon dimensions */]]></find>
				<action type="before-add"><![CDATA[/* Community Moderation */
.upvote-icon, .upvote-icon a		{ background: none top left no-repeat; }
.downvote-icon, .downvote-icon a		{ background: none top left no-repeat; }
]]></action>
			</edit>
			<edit>
				<find><![CDATA[ul.profile-icons li.warn-icon	{ width: {IMG_ICON_USER_WARN_WIDTH}px; height: {IMG_ICON_USER_WARN_HEIGHT}px; }]]></find>
				<action type="after-add"><![CDATA[ul.profile-icons li.upvote-icon	{ width: {IMG_ICON_POST_UPVOTE_WIDTH}px; height: {IMG_ICON_POST_UPVOTE_HEIGHT}px; }
ul.profile-icons li.downvote-icon	{ width: {IMG_ICON_POST_DOWNVOTE_WIDTH}px; height: {IMG_ICON_POST_DOWNVOTE_HEIGHT}px; }]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/theme/colours.css">
			<edit>
				<find><![CDATA[.warn-icon, .warn-icon a			{ background-image: url("{IMG_ICON_USER_WARN_SRC}"); } /* Need updated warn icon */]]></find>
				<action type="after-add"><![CDATA[.upvote-icon, .upvote-icon a		{ background-image: url("{IMG_ICON_POST_UPVOTE_SRC}"); }
.downvote-icon, .downvote-icon a		{ background-image: url("{IMG_ICON_POST_DOWNVOTE_SRC}"); }
]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/theme/common.css">
			<edit>
				<find><![CDATA[.clear {
	display: block;
	clear: both;
	font-size: 1px;
	line-height: 1px;
	background: transparent;
}]]></find>
				<action type="after-add"><![CDATA[
.score {
	font-size: 1.4em; 
	padding-top: 3px; 
}]]></action>
			</edit>
		</open>
		<open src="styles/subsilver2/imageset/en/imageset.cfg">
			<edit>
				<find><![CDATA[img_button_topic_reply = button_topic_reply.gif]]></find>
				<action type="after-add"><![CDATA[img_icon_post_upvote = icon_post_upvote.gif
img_icon_post_downvote = icon_post_downvote.gif]]></action>
			</edit>
		</open>
		<open src="styles/subsilver2/template/ucp_prefs_view.html">
			<edit>
				<find><![CDATA[	<td class="row2">{S_POST_SORT_DIR}</td>
</tr>]]></find>
				<action type="after-add"><![CDATA[<tr>
	<td colspan="2" class="spacer"></td>
</tr>
<!-- IF S_CAN_BURY_THRESHOLD -->
<tr>
	<td class="row1" width="50%"><b class="genmed">{L_POST_THRESHOLD}:</b><br /><span class="gensmall">{L_POST_THRESHOLD_EXPLAIN}</span></td>
	<td class="row2"><input class="post" type="text" name="post_threshold" size="5" maxlength="3" value="{S_BURY_THRESHOLD}" /></td>
</tr>
<!-- ENDIF -->
<!-- IF S_CAN_BURY_HIDE -->
<tr>
	<td class="row1" width="50%"><b class="genmed">{L_BURY_HIDE}:</b><br /><span class="gensmall">{L_BURY_HIDE_EXPLAIN}</span></td>
	<td class="row2"><input type="radio" class="radio" name="bury_hide" value="2"<!-- IF S_BURY_HIDE == 2 --> checked="checked"<!-- ENDIF --> /><span class="gen">{L_BURY_HIDE_NONE}</span>&nbsp; &nbsp;<input type="radio" class="radio" name="bury_hide" value="1"<!-- IF S_BURY_HIDE == 1 --> checked="checked"<!-- ENDIF --> /><span class="gen">{L_BURY_HIDE_FRIENDS}</span>&nbsp; &nbsp;<input type="radio" class="radio" name="bury_hide" value="0"<!-- IF S_BURY_HIDE == 0 --> checked="checked"<!-- ENDIF --> /><span class="gen">{L_BURY_HIDE_ALL}</span></td>
</tr>
<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/subsilver2/template/viewtopic_body.html">
			<edit>
				<find><![CDATA[			<td class="gensmall" colspan="2" height="25" align="center"><!-- IF postrow.S_FIRST_UNREAD --><a name="unread"></a><!-- ENDIF --><a name="p{postrow.POST_ID}"></a>{postrow.L_IGNORE_POST}</td>]]></find>
				<action type="after-add"><![CDATA[	<!-- ELSEIF postrow.S_BURIED_POST -->
			<td class="gensmall" colspan="2" height="25" align="center"><!-- IF postrow.S_FIRST_UNREAD --><a name="unread"></a><!-- ENDIF --><a name="p{postrow.POST_ID}"></a>{postrow.L_BURIED_POST}</td>]]></action>
			</edit>
			<edit>
				<find><![CDATA[								<!-- IF postrow.U_DELETE --><a href="{postrow.U_DELETE}">{DELETE_IMG}</a> <!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[								<!-- IF postrow.S_COMMUNITY_MOD_ENABLED -->
								  <!-- IF postrow.S_CAN_COMMUNITY_MOD and not postrow.S_HAS_VOTED -->
			                      <a href="{postrow.U_UPVOTE}">{UPVOTE_IMG}</a>
								  <a href="{postrow.U_DOWNVOTE}">{DOWNVOTE_IMG}</a>
								  <!-- ENDIF -->
								<span class="score" title="+{postrow.POST_UPVOTES} -{postrow.POST_DOWNVOTES}">{postrow.POST_SCORE}</span>
								<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/subsilver2/theme/stylesheet.css">
			<edit>
				<find><![CDATA[.username-coloured {
	font-weight: bold;
}]]></find>
				<action type="after-add"><![CDATA[
.score {
	font-size: 1.2em;
}]]></action>
			</edit>
		</open>
		
		<php-installer>install_community_moderation.php</php-installer>
		
		<diy-instructions lang="en">Go to the ACP -> Styles -> Imagesets; refresh each.
Go to the ACP -> Styles -> Templates; refresh each.
Go to the ACP -> Styles -> Themes; refresh each
Go to the ACP; purge the cache.
A new ACP module is added .MODS > Community Moderation > Configuration
Permissions to vote on posts are automatically added to several forum roles; but you may wish to customise the permissions for your forum.</diy-instructions>
	</action-group>
</mod>
